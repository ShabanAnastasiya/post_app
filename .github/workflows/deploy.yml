name: Deploy Supabase Migrations

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  deploy-migrations:
    name: Deploy Database Migrations
    runs-on: ubuntu-latest

    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.ACTION_TOKEN }}

    steps:
      # --- Ð¨ÐÐ“ 1: Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð´ ---
      - name: Checkout repository
        uses: actions/checkout@v3

      # --- Ð¨ÐÐ“ 2: Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ° Ð¿ÐµÑ€ÐµÐ´ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¾Ð¹ ---
      - name: Show YML file content
        run: |
          echo "================================================="
          echo ">>> 1. DEBUG: Checking workflow file content..."
          echo "================================================="
          cat .github/workflows/deploy.yml
          echo "================================================="

      # --- Ð¨ÐÐ“ 3: Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ CLI ---
      - name: Setup Supabase CLI
        uses: supabase/setup-cli-action@v2

      # --- Ð¨ÐÐ“ 4: Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ° Ð¿Ð¾ÑÐ»Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ ---
      - name: Check environment and CLI version
        run: |
          echo "================================================="
          echo ">>> 2. DEBUG: Checking environment..."
          echo "================================================="
          echo "GitHub Event: ${{ github.event_name }}"
          echo "Branch/Ref: ${{ github.ref }}"
          echo "Is ACTION_TOKEN set? (should not be empty): ${{ env.ACTION_TOKEN != '' }}"
          echo "---"
          echo "Checking Supabase CLI version..."
          supabase -v
          echo "================================================="

      # --- Ð¨ÐÐ“ 5: Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð² DEV ---
      - name: ðŸš€ Deploy migrations to DEV
        if: github.ref == 'refs/heads/develop'
        run: |
          echo "================================================="
          echo ">>> 3. ACTION: Deploying to DEV environment..."
          echo "================================================="
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID_DEV }}
          supabase db push --password ${{ secrets.SUPABASE_DB_PASSWORD_DEV }}
          echo "================================================="

      # --- Ð¨ÐÐ“ 6: Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð² PROD ---
      - name: ðŸš€ Deploy migrations to PROD
        if: github.ref == 'refs/heads/main'
        run: |
          echo "================================================="
          echo ">>> 3. ACTION: Deploying to PROD environment..."
          echo "================================================="
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID_PROD }}
          supabase db push --password ${{ secrets.SUPABASE_DB_PASSWORD_PROD }}
          echo "================================================="