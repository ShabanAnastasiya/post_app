name: Deploy Supabase Migrations

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  deploy-migrations:
    name: Deploy Database Migrations
    runs-on: ubuntu-latest

    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.ACTION_TOKEN }}

    steps:
      # --- ШАГ 1: Скачиваем код ---
      - name: Checkout repository
        uses: actions/checkout@v3

      # --- ШАГ 2: Диагностика перед установкой ---
      - name: Show YML file content
        run: |
          echo "================================================="
          echo ">>> 1. DEBUG: Checking workflow file content..."
          echo "================================================="
          cat .github/workflows/deploy.yml
          echo "================================================="

      # --- ШАГ 3: Устанавливаем CLI ---
      - name: Setup Supabase CLI
        uses: supabase/setup-cli-action@v2

      # --- ШАГ 4: Диагностика после установки ---
      - name: Check environment and CLI version
        run: |
          echo "================================================="
          echo ">>> 2. DEBUG: Checking environment..."
          echo "================================================="
          echo "GitHub Event: ${{ github.event_name }}"
          echo "Branch/Ref: ${{ github.ref }}"
          echo "Is ACTION_TOKEN set? (should not be empty): ${{ env.ACTION_TOKEN != '' }}"
          echo "---"
          echo "Checking Supabase CLI version..."
          supabase -v
          echo "================================================="

      # --- ШАГ 5: Деплой в DEV ---
      - name: 🚀 Deploy migrations to DEV
        if: github.ref == 'refs/heads/develop'
        run: |
          echo "================================================="
          echo ">>> 3. ACTION: Deploying to DEV environment..."
          echo "================================================="
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID_DEV }}
          supabase db push --password ${{ secrets.SUPABASE_DB_PASSWORD_DEV }}
          echo "================================================="

      # --- ШАГ 6: Деплой в PROD ---
      - name: 🚀 Deploy migrations to PROD
        if: github.ref == 'refs/heads/main'
        run: |
          echo "================================================="
          echo ">>> 3. ACTION: Deploying to PROD environment..."
          echo "================================================="
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID_PROD }}
          supabase db push --password ${{ secrets.SUPABASE_DB_PASSWORD_PROD }}
          echo "================================================="